---
import Layout from "@layout"
import { Picture } from "astro:assets"
import Specs from "@components/products/Specs.astro"
import Cta from "@components/Cta.astro"
import capitalizeFirstLetter from "@lib/capitalizeFirstLetter"
import products from "@/hooks/products"
import type { Product } from "@t/productTypes"

export function getStaticPaths() {
    type Path = {
        category: string
        id: string
    }

    const paths: Path[] = products.reduce((arr: Path[], category) => {
        const categoryPaths: Path[] = category.products
            .filter(({ availability, visibility }) => availability && visibility)
            .map(({ id }) => ({
                category: category.category,
                id,
            }))

        return arr.concat(categoryPaths)
    }, [])

    const params = paths.map((path) => {
        return { params: path }
    })

    return [...params]
}

const { category, id } = Astro.params
const product = products
    .find(({ category: title }) => title === category)
    ?.products.find(({ id: productName }) => productName === id) as Product

const images = import.meta.glob<{ default: ImageMetadata }>(
    `/src/assets/products/* - Fresh Jacuzzis.{jpeg,jpg,png,gif}`,
)
const imagePath = `/src/assets/products/${capitalizeFirstLetter(product.category ?? "")} ${product.name} - Fresh Jacuzzis.jpeg`
const image = await images[imagePath]()

// Obtener el primer color y render disponibles
const firstColor = product.colors ? Object.keys(product.colors)[0] : null
const firstRender = product.renders && firstColor ? product.renders[firstColor] : null

const hasSpecs = !!product.specs
const has360 = !!(product.colors && product.renders)
const hasVideo = !!product.video

// Tab inicial activa
const initialTab = hasSpecs ? "specs" : has360 ? "preview" : hasVideo ? "video" : null
---

<Layout title={`${capitalizeFirstLetter(product.category)} ${product.name} | Fresh HidroJacuzz`}>
    <!-- Botón Sticky - Ficha Técnica -->
    {
        product.datasheet && (
            <a
                href={product.datasheet}
                target="_blank"
                rel="noopener noreferrer"
                class="datasheet-badge"
                id="datasheetBadge"
                aria-label="Descargar Ficha Técnica"
            >
                <div class="badge-content">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                    </svg>
                    <span class="badge-text">Ficha Técnica</span>
                </div>
                <div class="badge-pulse" />
            </a>
        )
    }

    <section transition:name={`${product.category}-${product.id}`} class="product">
        <div class="hover-wrapper">
            <div class="hover-card">
                <Picture
                    loading="lazy"
                    src={image.default}
                    formats={["avif", "webp", "jpeg"]}
                    alt={`${capitalizeFirstLetter(product.category ?? "")} ${product.name} | Fresh HidroJacuzz`}
                    widths={[150, 300, 600]}
                    sizes="(max-width: 600px) 150px, (max-width: 1200px) 300px, 600px"
                    transition:name={`${product.category}-${product.id}-img`}
                />
            </div>
        </div>
        <div class="specs">
            <h1 transition:name={`${product.category}-${product.id}-title`}>
                {capitalizeFirstLetter(product.category ?? "")}
                {product.name}
            </h1>
            <Specs product={product} />
            <Cta transition:name={`${product.category}-${product.id}-btn`}>
                Cotiza ahora mismo
            </Cta>
        </div>
    </section>

    {/* Tabs Section */}
    {
        (hasSpecs || has360 || hasVideo) && (
            <section class="tabs-section" aria-labelledby="tabs-title">
                <h2 id="tabs-title" class="sr-only">
                    Detalles del Producto
                </h2>

                <div class="tabs-header" role="tablist">
                    {hasSpecs && (
                        <button
                            class={`tab-btn ${initialTab === "specs" ? "active" : ""}`}
                            id="tab-specs"
                            role="tab"
                            aria-selected={initialTab === "specs" ? "true" : "false"}
                            aria-controls="panel-specs"
                            tabindex={initialTab === "specs" ? "0" : "-1"}
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <polyline points="9 11 12 14 22 4" />
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                            </svg>
                            Características
                        </button>
                    )}
                    {has360 && (
                        <button
                            class={`tab-btn ${initialTab === "preview" ? "active" : ""}`}
                            id="tab-preview"
                            role="tab"
                            aria-selected={initialTab === "preview" ? "true" : "false"}
                            aria-controls="panel-preview"
                            tabindex={initialTab === "preview" ? "0" : "-1"}
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <circle cx="12" cy="12" r="10" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            Vista 360°
                        </button>
                    )}
                    {hasVideo && (
                        <button
                            class={`tab-btn ${initialTab === "video" ? "active" : ""}`}
                            id="tab-video"
                            role="tab"
                            aria-selected={initialTab === "video" ? "true" : "false"}
                            aria-controls="panel-video"
                            tabindex={initialTab === "video" ? "0" : "-1"}
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <polygon points="5 3 19 12 5 21 5 3" />
                            </svg>
                            Video
                        </button>
                    )}
                </div>

                <div class="tabs-content">
                    {hasSpecs && (
                        <div
                            class={`tab-panel ${initialTab === "specs" ? "active" : ""}`}
                            id="panel-specs"
                            role="tabpanel"
                            aria-labelledby="tab-specs"
                            hidden={initialTab !== "specs"}
                        >
                            <div class="panel-inner">
                                <h3 class="panel-title">Características del Producto</h3>
                                <div class="product-specs">
                                    {product.specs?.map?.(({ title, list }) => {
                                        return (
                                            <div class="specs-level">
                                                <h4>{title}</h4>
                                                <ul>
                                                    {list.map((spec) => (
                                                        <li>{spec}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )
                                    })}
                                </div>
                                <div class="panel-cta">
                                    <Cta>¡Cotiza ahora!</Cta>
                                </div>
                            </div>
                        </div>
                    )}

                    {has360 && (
                        <div
                            class={`tab-panel ${initialTab === "preview" ? "active" : ""}`}
                            id="panel-preview"
                            role="tabpanel"
                            aria-labelledby="tab-preview"
                            hidden={initialTab !== "preview"}
                        >
                            <div class="panel-inner">
                                <h3 class="panel-title">Explora en Realidad Virtual</h3>
                                <p class="preview-subtitle">
                                    Selecciona tu color favorito y experimenta el recorrido 360°
                                </p>

                                <div
                                    class="color-palette"
                                    role="radiogroup"
                                    aria-label="Selección de color"
                                >
                                    {product.colors &&
                                        Object.entries(product.colors).map(
                                            ([colorName, colorHex], index) => (
                                                <button
                                                    class={`color-card ${index === 0 ? "active" : ""}`}
                                                    data-color={colorName}
                                                    data-render={product.renders?.[colorName]}
                                                    role="radio"
                                                    aria-checked={index === 0}
                                                    type="button"
                                                    aria-label={`Color ${colorName}`}
                                                >
                                                    <div
                                                        class="color-circle"
                                                        style={`background-color: ${colorHex};`}
                                                    />
                                                    <span class="color-card-name">{colorName}</span>
                                                    <div class="color-checkmark">
                                                        <svg
                                                            xmlns="http://www.w3.org/2000/svg"
                                                            width="16"
                                                            height="16"
                                                            viewBox="0 0 24 24"
                                                            fill="none"
                                                            stroke="currentColor"
                                                            stroke-width="3"
                                                        >
                                                            <polyline points="20 6 9 17 4 12" />
                                                        </svg>
                                                    </div>
                                                </button>
                                            ),
                                        )}
                                </div>

                                <div class="render-frame">
                                    <iframe
                                        id="renderIframe"
                                        data-src={firstRender}
                                        frameborder="0"
                                        allowfullscreen
                                        loading="lazy"
                                        title={`Vista 360° del ${product.name}`}
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                    {hasVideo && (
                        <div
                            class={`tab-panel ${initialTab === "video" ? "active" : ""}`}
                            id="panel-video"
                            role="tabpanel"
                            aria-labelledby="tab-video"
                            hidden={initialTab !== "video"}
                        >
                            <div class="panel-inner">
                                <h3 class="panel-title">Video del Producto</h3>
                                <div class="video-frame">
                                    <iframe
                                        id="videoIframe"
                                        data-src={product.video}
                                        frameborder="0"
                                        allowfullscreen
                                        loading="lazy"
                                        title={`Video de ${product.name}`}
                                    />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            </section>
        )
    }
</Layout>

<style>
    .product {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 20px auto;
        perspective: 1000px;
    }

    .hover-wrapper {
        position: relative;
        width: 90vw;
        height: 90vw;
    }

    .hover-card {
        width: 100%;
        height: 100%;
        border-radius: 10px;
        overflow: hidden;
        transition:
            transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
            box-shadow 0.3s ease;
        will-change: transform;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        background: white;
    }

    .hover-wrapper:hover .hover-card {
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
        z-index: 10;
    }

    picture {
        width: 100%;
        height: 100%;
        display: block;
    }

    img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 10px;
    }

    .specs {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 10px;
        justify-content: space-around;
        align-items: center;
        margin-top: 1.5rem;
    }

    h1 {
        font-size: 2.5rem;
        color: var(--primary-dark);
        text-align: center;
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
    }

    /* Datasheet Badge */
    .datasheet-badge {
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
        color: white;
        border-radius: 50px;
        z-index: 1000;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        box-shadow: 0 6px 24px rgba(196, 145, 47, 0.4);
    }

    .badge-content {
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        z-index: 2;
    }
    .badge-text {
        font-size: 0.95rem;
        font-weight: 600;
    }
    .badge-pulse {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        border-radius: 50px;
        background: var(--secondary-color);
        opacity: 0;
        animation: pulse 2s ease-out infinite;
    }
    @keyframes pulse {
        0% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0.6;
        }
        100% {
            transform: translate(-50%, -50%) scale(1.5);
            opacity: 0;
        }
    }
    .datasheet-badge:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 32px rgba(196, 145, 47, 0.5);
    }

    /* Tabs */
    .tabs-section {
        margin: 3rem auto;
        padding: 0 1rem;
        min-height: 80vh;
        display: flex;
        flex-direction: column;
        max-width: 1200px;
    }
    .tabs-header {
        display: flex;
        gap: 2rem;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 2rem;
        justify-content: center;
    }
    .tab-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 1rem 1.5rem;
        background: transparent;
        border: none;
        color: var(--text-light);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
    }
    .tab-btn::after {
        content: "";
        position: absolute;
        bottom: -3px;
        left: 0;
        width: 0;
        height: 3px;
        background: var(--primary-color);
        transition: width 0.3s ease;
    }
    .tab-btn.active {
        color: var(--primary-color);
    }
    .tab-btn.active::after {
        width: 100%;
    }
    .tab-btn:hover {
        color: var(--primary-dark);
        background-color: rgba(32, 59, 118, 0.05);
    }

    .tabs-content {
        position: relative;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .tab-panel {
        display: none;
        animation: fadeIn 0.4s ease;
        flex: 1;
    }
    .tab-panel.active {
        display: block;
    }
    .panel-inner {
        padding: 1rem;
    }
    .panel-title {
        color: var(--primary-dark);
        text-align: center;
        font-size: 2rem;
        margin-bottom: 2rem;
    }
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Specs & Colors & Video */
    .product-specs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }
    .specs-level {
        background: var(--accent-light);
        padding: 2rem;
        border-radius: 12px;
        transition: transform 0.3s ease;
    }
    .specs-level:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }
    h4 {
        font-size: 1.5rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        border-bottom: 2px solid white;
        padding-bottom: 0.5rem;
    }
    ul {
        list-style-type: none;
        padding-left: 0;
    }
    li {
        font-size: 1rem;
        color: var(--text-dark);
        padding: 0.5rem 0;
        padding-left: 1.5rem;
        position: relative;
    }
    li::before {
        content: "✓";
        position: absolute;
        left: 0;
        color: var(--primary-color);
        font-weight: bold;
    }
    .panel-cta {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }

    .preview-subtitle {
        text-align: center;
        color: var(--text-light);
        margin-bottom: 2rem;
        font-size: 1.1rem;
    }
    .color-palette {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        justify-content: center;
        margin-bottom: 3rem;
    }
    .color-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        background: white;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
        min-width: 120px;
        border: 2px solid transparent;
    }
    .color-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    .color-card.active {
        background: var(--accent-light);
        border-color: var(--primary-color);
    }
    .color-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid #e0e0e0;
        transition: all 0.3s ease;
    }
    .color-card.active .color-circle {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(32, 59, 118, 0.15);
    }
    .color-card-name {
        font-size: 0.9rem;
        color: var(--text-dark);
        font-weight: 500;
    }
    .color-checkmark {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        background: var(--primary-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transform: scale(0);
        transition: all 0.3s ease;
    }
    .color-checkmark svg {
        stroke: white;
    }
    .color-card.active .color-checkmark {
        opacity: 1;
        transform: scale(1);
    }
    .render-frame,
    .video-frame {
        width: 100%;
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        background: #f5f5f5;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        aspect-ratio: 16/9;
        max-width: 1000px;
        margin: 0 auto;
    }
    .render-frame iframe,
    .video-frame iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
    }

    /* RESPONSIVE */
    @media (min-width: 800px) {
        h1 {
            width: 30vw;
            text-align: center;
        }
        .hover-wrapper {
            width: 40vw;
            height: 40vw;
        }
        .product {
            flex-direction: row;
        }
        .specs {
            text-align: center;
            padding: 0 5rem;
            height: auto;
            align-items: center;
            margin-top: 0;
            justify-content: center;
        }
        .render-frame,
        .video-frame {
            height: 600px;
            aspect-ratio: auto;
        }
        .color-card {
            min-width: 140px;
        }
        .color-circle {
            width: 70px;
            height: 70px;
        }
    }
    @media (max-width: 600px) {
        .badge-text {
            display: none;
        }
        .datasheet-badge {
            padding: 14px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tab-btn {
            flex: 1;
            justify-content: center;
            padding: 0.8rem 1rem;
            font-size: 0.95rem;
        }
        .tabs-header {
            gap: 0;
        }
    }
</style>

<script>
    import { $ } from "@/lib/dom-selector"

    const initProductPage = () => {
        // === EFECTO HOVER CARD ===
        const wrapper = $<HTMLDivElement>(".hover-wrapper")
        const card = $<HTMLDivElement>(".hover-card")

        if (wrapper && card) {
            wrapper.addEventListener("mousemove", (e) => {
                const rect = wrapper.getBoundingClientRect()
                const x = (e.clientX - rect.left) / rect.width - 0.5
                const y = (e.clientY - rect.top) / rect.height - 0.5

                card.style.transform = `
                    scale(1.03)
                    translate(${x * 15}px, ${y * 15}px)
                    rotateX(${-y * 4}deg)
                    rotateY(${x * 4}deg)
                `
            })

            wrapper.addEventListener("mouseleave", () => {
                card.style.transform = "scale(1) translate(0, 0) rotate(0)"
            })
        }

        // Tabs
        const tabButtons = document.querySelectorAll(".tab-btn")
        const tabPanels = document.querySelectorAll(".tab-panel")

        tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const targetTab = button.getAttribute("id")?.replace("tab-", "panel-")
                if (!targetTab) return

                tabButtons.forEach((btn) => {
                    btn.classList.remove("active")
                    btn.setAttribute("aria-selected", "false")
                    btn.setAttribute("tabindex", "-1")
                })
                tabPanels.forEach((panel) => {
                    panel.classList.remove("active")
                    panel.setAttribute("hidden", "")
                })

                button.classList.add("active")
                button.setAttribute("aria-selected", "true")
                button.setAttribute("tabindex", "0")

                const targetPanel = document.getElementById(targetTab)
                if (targetPanel) {
                    targetPanel.classList.add("active")
                    targetPanel.removeAttribute("hidden")

                    // Lazy load iframes in the panel
                    const iframes = targetPanel.querySelectorAll("iframe[data-src]")
                    iframes.forEach((iframe) => {
                        const htmlIframe = iframe as HTMLIFrameElement
                        if (!htmlIframe.src && htmlIframe.getAttribute("data-src")) {
                            htmlIframe.src = htmlIframe.getAttribute("data-src") || ""
                        }
                    })
                }
            })
        })

        // Colors (Vista 360)
        const colorCards = document.querySelectorAll(".color-card")
        const renderIframe = document.getElementById("renderIframe") as HTMLIFrameElement

        colorCards.forEach((card) => {
            card.addEventListener("click", () => {
                colorCards.forEach((c) => {
                    c.classList.remove("active")
                    c.setAttribute("aria-checked", "false")
                })
                card.classList.add("active")
                card.setAttribute("aria-checked", "true")

                const renderUrl = card.getAttribute("data-render")
                if (renderUrl && renderIframe) {
                    renderIframe.src = renderUrl
                }
            })
        })

        // Initial lazy load for active tab iframe
        const activePanel = document.querySelector(".tab-panel.active")
        if (activePanel) {
            const iframes = activePanel.querySelectorAll("iframe[data-src]")
            iframes.forEach((iframe) => {
                const htmlIframe = iframe as HTMLIFrameElement
                if (!htmlIframe.src && htmlIframe.getAttribute("data-src")) {
                    htmlIframe.src = htmlIframe.getAttribute("data-src") || ""
                }
            })
        }
    }

    // Run on initial load and view transitions
    document.addEventListener("astro:page-load", initProductPage)
</script>
